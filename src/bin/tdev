#!/bin/bash


if [ -z $1 ]
then
    echo "Usage: $0 <project name> [-p3]"
    exit 2
fi

projname=$1

venvsource="$HOME/.virtualenvs/$projname/bin/activate"
projdir=$HOME/devel/$projname

del_env(){
    rm -rf $venvsrc
    rm -rf $projdir
    echo "Done deleting environement"
    exit
}

build_env(){
    if [ "$2" == "-p3" ]
    then
        v=3
    else
        v=2
    fi

    echo "building environement with python$v" 
    python=`which python$v`

    echo "Project does not have a virtual environement"
    echo "Creating one right now ..."
    sleep 2
    source /usr/share/virtualenvwrapper/virtualenvwrapper.sh
    mkvirtualenv -i ipython -i ipdb -i jedi -p `which python3` $projname
    pip install ipython
    pip install ipdb 
    pip install jedi
    pip install flake8
    pip install autopep8
}

build_wdir(){
    echo "The project does not have a working directory"
    echo "creating one right now ..."
    sleep 2
    mkdir -p -v $projdir/src/
    echo "creating stup setup.py file"
    echo "can you ask for better..."
    mksetup $projname $projdir/

    echo "initializing git repository and setting version tag to 0.0"
    cd $projdir
    git init
    git add src/setup.py src/MANIFEST.in .gitignore
    git commit -m "initial commit of skeleton"
    git tag 0.0
}

connect_env(){
    if tmux a -t $projname
    then
        echo "Found active session and attached"
    else
        echo "Could not attach to session"
        tmux new-session -s $projname -d "source $HOME/.virtualenvs/$projname/bin/activate; vim "
        tmux split-window -t $projname -v -p 30 "source $HOME/.virtualenvs/$projname/bin/activate; $SHELL"
        tmux -2 attach-session -d -t $projname
    fi
}

if [ "$2" == "-d" ]
then
    del_env
fi

if [ ! -f $venvsource ]
then
    build_env
fi


if [ ! -d $projdir ]
then
    build_wdir
fi

connect_env

cd $projdir

